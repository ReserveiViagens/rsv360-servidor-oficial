version: '3.8'
services:
  performance-service:
    image: node:18-alpine
    container_name: rsv-performance-service
    ports:
      - "5008:5008"
    environment:
      - NODE_ENV=development
      - PORT=5008
      - SERVICE_NAME=RSV360-Performance-Service
    command: >
      sh -c "
        apk add --no-cache curl &&
        mkdir -p /app && cd /app &&
        echo 'const express = require(\"express\");
        const cors = require(\"cors\");
        const compression = require(\"compression\");
        const app = express();
        const port = 5008;
        
        app.use(cors());
        app.use(compression());
        app.use(express.json());
        
        // Performance metrics
        let performanceMetrics = {
          responseTimes: [],
          throughput: 0,
          cacheHits: 0,
          cacheMisses: 0,
          optimizations: []
        };
        
        // Health check
        app.get(\"/health\", (req, res) => {
          const startTime = Date.now();
          res.json({
            status: \"healthy\",
            service: \"RSV360 Performance Service\",
            timestamp: new Date().toISOString(),
            port: port,
            uptime: process.uptime(),
            performance: {
              averageResponseTime: performanceMetrics.responseTimes.length > 0 ? 
                performanceMetrics.responseTimes.reduce((a, b) => a + b, 0) / performanceMetrics.responseTimes.length : 0,
              throughput: performanceMetrics.throughput,
              cacheHitRate: performanceMetrics.cacheHits / (performanceMetrics.cacheHits + performanceMetrics.cacheMisses) * 100 || 0
            }
          });
          const responseTime = Date.now() - startTime;
          performanceMetrics.responseTimes.push(responseTime);
          if (performanceMetrics.responseTimes.length > 100) {
            performanceMetrics.responseTimes.shift();
          }
        });
        
        // Performance status
        app.get(\"/api/v1/status\", (req, res) => {
          performanceMetrics.throughput++;
          res.json({
            success: true,
            message: \"RSV360 Performance Service is running\",
            version: \"1.0.0\",
            timestamp: new Date().toISOString(),
            endpoints: [
              \"GET /api/v1/performance\",
              \"GET /api/v1/optimizations\",
              \"POST /api/v1/optimize\",
              \"GET /api/v1/cache-stats\"
            ]
          });
        });
        
        // Get performance metrics
        app.get(\"/api/v1/performance\", (req, res) => {
          performanceMetrics.throughput++;
          res.json({
            success: true,
            data: {
              responseTime: {
                average: performanceMetrics.responseTimes.length > 0 ? 
                  performanceMetrics.responseTimes.reduce((a, b) => a + b, 0) / performanceMetrics.responseTimes.length : 0,
                min: performanceMetrics.responseTimes.length > 0 ? Math.min(...performanceMetrics.responseTimes) : 0,
                max: performanceMetrics.responseTimes.length > 0 ? Math.max(...performanceMetrics.responseTimes) : 0,
                p95: performanceMetrics.responseTimes.length > 0 ? 
                  performanceMetrics.responseTimes.sort((a, b) => a - b)[Math.floor(performanceMetrics.responseTimes.length * 0.95)] : 0
              },
              throughput: performanceMetrics.throughput,
              cache: {
                hits: performanceMetrics.cacheHits,
                misses: performanceMetrics.cacheMisses,
                hitRate: performanceMetrics.cacheHits / (performanceMetrics.cacheHits + performanceMetrics.cacheMisses) * 100 || 0
              },
              system: {
                memory: process.memoryUsage(),
                uptime: process.uptime(),
                cpu: process.cpuUsage()
              }
            }
          });
        });
        
        // Get optimizations
        app.get(\"/api/v1/optimizations\", (req, res) => {
          performanceMetrics.throughput++;
          res.json({
            success: true,
            data: {
              optimizations: [
                { name: \"Compression\", status: \"enabled\", impact: \"high\" },
                { name: \"Caching\", status: \"enabled\", impact: \"high\" },
                { name: \"Connection Pooling\", status: \"enabled\", impact: \"medium\" },
                { name: \"Load Balancing\", status: \"enabled\", impact: \"high\" },
                { name: \"CDN\", status: \"enabled\", impact: \"medium\" }
              ],
              recommendations: [
                \"Enable Redis caching for frequently accessed data\",
                \"Implement database connection pooling\",
                \"Use compression for API responses\",
                \"Implement rate limiting\",
                \"Enable HTTP/2 for better performance\"
              ]
            }
          });
        });
        
        // Cache stats
        app.get(\"/api/v1/cache-stats\", (req, res) => {
          performanceMetrics.throughput++;
          res.json({
            success: true,
            data: {
              cache: {
                hits: performanceMetrics.cacheHits,
                misses: performanceMetrics.cacheMisses,
                hitRate: performanceMetrics.cacheHits / (performanceMetrics.cacheHits + performanceMetrics.cacheMisses) * 100 || 0,
                totalRequests: performanceMetrics.cacheHits + performanceMetrics.cacheMisses
              },
              performance: {
                averageResponseTime: performanceMetrics.responseTimes.length > 0 ? 
                  performanceMetrics.responseTimes.reduce((a, b) => a + b, 0) / performanceMetrics.responseTimes.length : 0,
                throughput: performanceMetrics.throughput
              }
            }
          });
        });
        
        app.listen(port, () => console.log(\"RSV360 Performance Service running on port \" + port));
        ' > server.js &&
        npm init -y && npm install express cors compression && node server.js
      "
    restart: unless-stopped
