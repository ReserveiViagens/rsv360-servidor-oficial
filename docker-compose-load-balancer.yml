version: '3.8'
services:
  load-balancer:
    image: nginx:1.25.3
    container_name: rsv-load-balancer
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    restart: unless-stopped
    depends_on:
      - api-gateway-1
      - api-gateway-2
      - api-gateway-3
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost/health']
      interval: 30s
      timeout: 10s
      retries: 3

  # Múltiplas instâncias do API Gateway para load balancing
  api-gateway-1:
    image: node:18-alpine
    container_name: rsv-api-gateway-1
    ports:
      - '8081:8080'
    environment:
      - NODE_ENV=production
      - PORT=8080
      - SERVICE_NAME=RSV360-API-Gateway-1
    command: >
      sh -c "
        apk add --no-cache curl &&
        mkdir -p /app && cd /app &&
        echo 'const express = require(\"express\");
        const cors = require(\"cors\");
        const app = express();
        const port = 8080;
        
        app.use(cors());
        app.use(express.json());
        
        app.get(\"/health\", (req, res) => {
          res.json({
            status: \"healthy\",
            service: \"RSV360 API Gateway 1\",
            timestamp: new Date().toISOString(),
            port: port,
            instance: 1
          });
        });
        
        app.get(\"/api/v1/status\", (req, res) => {
          res.json({
            success: true,
            message: \"RSV360 API Gateway 1 is running\",
            version: \"1.0.0\",
            timestamp: new Date().toISOString(),
            instance: 1
          });
        });
        
        app.listen(port, () => console.log(\"RSV360 API Gateway 1 running on port \" + port));
        ' > server.js &&
        npm init -y && npm install express cors && node server.js
      "
    restart: unless-stopped

  api-gateway-2:
    image: node:18-alpine
    container_name: rsv-api-gateway-2
    ports:
      - '8082:8080'
    environment:
      - NODE_ENV=production
      - PORT=8080
      - SERVICE_NAME=RSV360-API-Gateway-2
    command: >
      sh -c "
        apk add --no-cache curl &&
        mkdir -p /app && cd /app &&
        echo 'const express = require(\"express\");
        const cors = require(\"cors\");
        const app = express();
        const port = 8080;
        
        app.use(cors());
        app.use(express.json());
        
        app.get(\"/health\", (req, res) => {
          res.json({
            status: \"healthy\",
            service: \"RSV360 API Gateway 2\",
            timestamp: new Date().toISOString(),
            port: port,
            instance: 2
          });
        });
        
        app.get(\"/api/v1/status\", (req, res) => {
          res.json({
            success: true,
            message: \"RSV360 API Gateway 2 is running\",
            version: \"1.0.0\",
            timestamp: new Date().toISOString(),
            instance: 2
          });
        });
        
        app.listen(port, () => console.log(\"RSV360 API Gateway 2 running on port \" + port));
        ' > server.js &&
        npm init -y && npm install express cors && node server.js
      "
    restart: unless-stopped

  api-gateway-3:
    image: node:18-alpine
    container_name: rsv-api-gateway-3
    ports:
      - '8083:8080'
    environment:
      - NODE_ENV=production
      - PORT=8080
      - SERVICE_NAME=RSV360-API-Gateway-3
    command: >
      sh -c "
        apk add --no-cache curl &&
        mkdir -p /app && cd /app &&
        echo 'const express = require(\"express\");
        const cors = require(\"cors\");
        const app = express();
        const port = 8080;
        
        app.use(cors());
        app.use(express.json());
        
        app.get(\"/health\", (req, res) => {
          res.json({
            status: \"healthy\",
            service: \"RSV360 API Gateway 3\",
            timestamp: new Date().toISOString(),
            port: port,
            instance: 3
          });
        });
        
        app.get(\"/api/v1/status\", (req, res) => {
          res.json({
            success: true,
            message: \"RSV360 API Gateway 3 is running\",
            version: \"1.0.0\",
            timestamp: new Date().toISOString(),
            instance: 3
          });
        });
        
        app.listen(port, () => console.log(\"RSV360 API Gateway 3 running on port \" + port));
        ' > server.js &&
        npm init -y && npm install express cors && node server.js
      "
    restart: unless-stopped
